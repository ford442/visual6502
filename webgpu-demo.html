<!DOCTYPE html>
<html>
<head>
    <title>Visual 6502 - WebGPU Upgrade</title>
    <style>
        body { margin: 0; background: #050505; color: #fff; font-family: monospace; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #444; pointer-events: none;}
    </style>
    <script src="https://unpkg.com/earcut@2.2.4/dist/earcut.min.js"></script>
</head>
<body>
    <div id="ui">
        <h3>Cyber-Silicon 6502</h3>
        <p>Status: <span id="status">Initializing...</span></p>
    </div>
    <canvas id="screen"></canvas>

    <script src="segdefs.js"></script>
    <script src="webgpu-renderer.js"></script>

    <script>
        const canvas = document.getElementById('screen');
        const status = document.getElementById('status');
        
        // Initialize Renderer
        const renderer = new WebGPURenderer(canvas);
        
        // Mock Node State (Simulation Stub)
        const numNodes = 6000;
        const nodeStates = new Array(numNodes).fill(0);

        async function main() {
            try {
                if (typeof segdefs === 'undefined') throw new Error("segdefs.js not loaded.");
                if (typeof earcut === 'undefined') throw new Error("Earcut library not loaded.");

                status.innerText = "Processing Geometry...";
                
                // Allow UI to update before heavy processing
                setTimeout(async () => {
                    await renderer.init(segdefs, 'images/chip_bg.bmp');
                    status.innerText = "Running WebGPU";
                    loop();
                }, 100);

                let time = 0;
                function loop() {
                    time += 0.01;
                    // Simulate random activity
                    for(let i=0; i<100; i++) {
                        const rNode = Math.floor(Math.random() * numNodes);
                        nodeStates[rNode] = Math.random() > 0.5 ? 1 : 0;
                    }
                    
                    renderer.updateNodeStates(nodeStates);
                    // Params: time, zoom, panX, panY
                    renderer.render(time, 0.9, 0.0, 0.0);
                    requestAnimationFrame(loop);
                }

            } catch (e) {
                console.error(e);
                status.innerText = "Error: " + e.message;
                status.style.color = "red";
            }
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if(renderer) renderer.resize(canvas.width, canvas.height);
        }
        window.addEventListener('resize', resize);
        resize();

        main();
    </script>
</body>
</html>
