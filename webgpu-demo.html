<!DOCTYPE html>
<html>
<head>
    <title>Visual 6502 - WebGPU Upgrade</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: monospace; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #ui { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #444; }
    </style>
</head>
<body>
    <div id="ui">
        <h3>Cyber-Silicon 6502</h3>
        <p>Status: <span id="status">Initializing...</span></p>
    </div>
    <canvas id="screen"></canvas>

    <script src="segdefs.js"></script>
    <script src="webgpu-renderer.js"></script>

    <script>
        const canvas = document.getElementById('screen');
        const status = document.getElementById('status');
        
        // Initialize Renderer
        const renderer = new WebGPURenderer(canvas);
        
        // Mock Node State (Simulation Stub)
        // In the real app, this array comes from the chipsim step() function
        const numNodes = 6000;
        const nodeStates = new Array(numNodes).fill(0);

        async function main() {
            try {
                // Ensure segdefs is loaded
                if (typeof segdefs === 'undefined') {
                    throw new Error("segdefs.js not loaded. Check file path.");
                }

                status.innerText = "Building Geometry...";
                await renderer.init(segdefs);
                status.innerText = "Running WebGPU";

                // Animation Loop
                let time = 0;
                function loop() {
                    time += 0.01;

                    // Simulate some blinking lights randomly
                    for(let i=0; i<50; i++) {
                        const rNode = Math.floor(Math.random() * numNodes);
                        nodeStates[rNode] = Math.random() > 0.5 ? 1 : 0;
                    }
                    
                    // Upload State
                    renderer.updateNodeStates(nodeStates);

                    // Render
                    // params: time, zoom, panX, panY
                    renderer.render(time, 1.0, 0.0, 0.0);

                    requestAnimationFrame(loop);
                }
                loop();

            } catch (e) {
                console.error(e);
                status.innerText = "Error: " + e.message;
                status.style.color = "red";
            }
        }

        // Adjust canvas size
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        main();
    </script>
</body>
</html>
